(function(){var g;if(typeof exports!=="undefined"){g=exports}else{g=this.Spine={}}g.version="0.0.2";var e=this.jQuery||this.Zepto;var b=function(j){return Array.prototype.slice.call(j,0)};var i=g.Events={bind:function(m,n){var j=m.split(" ");var l=this._callbacks||(this._callbacks={});for(var k=0;k<j.length;k++){(this._callbacks[j[k]]||(this._callbacks[j[k]]=[])).push(n)}return this},trigger:function(){var k=b(arguments);var o=k.shift();var p,n,m,j;if(!(n=this._callbacks)){return this}if(!(p=this._callbacks[o])){return this}for(m=0,j=p.length;m<j;m++){if(p[m].apply(this,k)===false){return false}}return this},unbind:function(n,p){if(!n){this._callbacks={};return this}var o,m,k,j;if(!(m=this._callbacks)){return this}if(!(o=this._callbacks[n])){return this}for(k=0,j=o.length;k<j;k++){if(p===o[k]){o.splice(k,1);break}}return this}};var f=g.Log={trace:true,logPrefix:"(App)",log:function(){if(!this.trace){return}if(typeof console=="undefined"){return}var j=b(arguments);if(this.logPrefix){j.unshift(this.logPrefix)}console.log.apply(console,j);return this}};if(typeof Object.create!=="function"){Object.create=function(k){function j(){}j.prototype=k;return new j()}}var h=["included","extended","setup"];var a=g.Class={initializer:function(){},init:function(){},prototype:{initializer:function(){},init:function(){}},create:function(j,l){var k=Object.create(this);k.parent=this;k.prototype=k.fn=Object.create(this.prototype);if(j){k.include(j)}if(l){k.extend(l)}k.initializer.apply(k,arguments);k.init.apply(k,arguments);return k},inst:function(){var j=Object.create(this.prototype);j.parent=this;j.initializer.apply(j,arguments);j.init.apply(j,arguments);return j},proxy:function(k){var j=this;return(function(){return k.apply(j,arguments)})},proxyAll:function(){var k=b(arguments);for(var j=0;j<k.length;j++){this[k[j]]=this.proxy(this[k[j]])}},include:function(l){for(var j in l){if(h.indexOf(j)==-1){this.fn[j]=l[j]}}var k=l.included||l.setup;if(k){k.apply(this)}return this},extend:function(l){for(var k in l){if(h.indexOf(k)==-1){this[k]=l[k]}}var j=l.extended||l.setup;if(j){j.apply(this)}return this}};a.prototype.proxy=a.proxy;a.prototype.proxyAll=a.proxyAll;g.guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(l){var k=Math.random()*16|0,j=l=="x"?k:(k&3|8);return j.toString(16)}).toUpperCase()};var c=g.Model=a.create();c.extend(i);c.createSub=c.create;c.setup=function(k,l){var j=c.createSub();if(k){j.name=k}if(l){j.attributes=l}return j};c.extend({initializer:function(){this.records={};this.attributes=[];this.bind("create",this.proxy(function(j){this.trigger("change","create",j)}));this.bind("update",this.proxy(function(j){this.trigger("change","update",j)}));this.bind("destroy",this.proxy(function(j){this.trigger("change","destroy",j)}))},find:function(k){var j=this.records[k];if(!j){throw ("Unknown record")}return j.dup()},exists:function(k){try{return this.find(k)}catch(j){return false}},refresh:function(l){this.records={};for(var m=0,k=l.length;m<k;m++){var j=this.inst(l[m]);j.newRecord=false;this.records[j.id]=j}this.trigger("refresh")},select:function(l){var j=[];for(var k in this.records){if(l(this.records[k])){j.push(this.records[k])}}return this.dupArray(j)},findByAttribute:function(j,l){for(var k in this.records){if(this.records[k][j]==l){return this.records[k].dup()}}},findAllByAttribute:function(j,k){return(this.select(function(l){return(l[j]==k)}))},each:function(k){for(var j in this.records){k(this.records[j])}},all:function(){return this.dupArray(this.recordsValues())},first:function(){var j=this.recordsValues()[0];return(j&&j.dup())},last:function(){var k=this.recordsValues();var j=k[k.length-1];return(j&&j.dup())},count:function(){return this.recordsValues().length},deleteAll:function(){for(var j in this.records){delete this.records[j]}},destroyAll:function(){for(var j in this.records){this.records[j].destroy()}},update:function(k,j){this.find(k).updateAttributes(j)},create:function(k){var j=this.inst(k);j.save();return j},destroy:function(j){this.find(j).destroy()},sync:function(j){this.bind("change",j)},fetch:function(j){j?this.bind("fetch",j):this.trigger("fetch")},toJSON:function(){return this.recordsValues()},recordsValues:function(){var j=[];for(var k in this.records){j.push(this.records[k])}return j},dupArray:function(l){var j=[];for(var k=0;k<l.length;k++){j.push(l[k].dup())}return j}});c.include({model:true,newRecord:true,init:function(j){if(j){this.load(j)}},isNew:function(){return this.newRecord},validate:function(){},load:function(k){for(var j in k){this[j]=k[j]}},attributes:function(){var k={};for(var l=0;l<this.parent.attributes.length;l++){var j=this.parent.attributes[l];k[j]=this[j]}k.id=this.id;return k},eql:function(j){return(j&&j.id===this.id&&j.parent===this.parent)},save:function(){var j=this.validate();if(j){if(!this.trigger("error",j)){throw ("Validation failed: "+j)}}this.trigger("beforeSave");this.newRecord?this.create():this.update();this.trigger("save")},updateAttribute:function(j,k){this[j]=k;return this.save()},updateAttributes:function(j){this.load(j);return this.save()},destroy:function(){this.trigger("beforeDestroy");delete this.parent.records[this.id];this.trigger("destroy")},dup:function(){var j=this.parent.inst(this.attributes());j.newRecord=this.newRecord;return j},reload:function(){return(this.parent.find(this.id))},toJSON:function(){return(this.attributes())},exists:function(){return(this.id&&this.id in this.parent.records)},update:function(){this.trigger("beforeUpdate");this.parent.records[this.id]=this.dup();this.trigger("update")},create:function(){this.trigger("beforeCreate");if(!this.id){this.id=g.guid()}this.newRecord=false;this.parent.records[this.id]=this.dup();this.trigger("create")},bind:function(j,k){this.parent.bind(j,this.proxy(function(l){if(l&&this.eql(l)){k.apply(this,arguments)}}))},trigger:function(k){var j=b(arguments);j.splice(1,0,this);this.parent.trigger.apply(this.parent,j)}});var d=g.Controller=a.create({tag:"div",initializer:function(j){this.options=j;for(var k in this.options){this[k]=this.options[k]}if(!this.el){this.el=document.createElement(this.tag)}this.el=e(this.el);if(!this.events){this.events=this.parent.events}if(!this.elements){this.elements=this.parent.elements}if(this.events){this.delegateEvents()}if(this.elements){this.refreshElements()}if(this.proxied){this.proxyAll.apply(this,this.proxied)}},render:function(){},$:function(j){return e(j,this.el)},eventSplitter:/^(\w+)\s*(.*)$/,delegateEvents:function(){for(var n in this.events){var l=this.events[n];var o=this.proxy(this[l]);var m=n.match(this.eventSplitter);var k=m[1],j=m[2];if(j===""){this.el.bind(k,o)}else{this.el.delegate(j,k,o)}}},refreshElements:function(){for(var j in this.elements){this[this.elements[j]]=this.$(j)}},delay:function(j,k){setTimeout(this.proxy(j),k||0)}});d.include(i);d.include(f);g.App=d.create({create:function(j){this.parent.include(j)}}).inst();d.fn.App=g.App})();